### Buddy System Design Document

#### 概述
Buddy System 是一种内存管理算法，用于管理动态分配和释放的内存块。其核心思想是将内存分成大小不同的分区，每个分区的大小为 2 的幂。在分配和回收内存时，Buddy System 通过合并和分割这些块来优化内存的利用率，减小内存碎片。

本实现的 Buddy System 使用多个空闲链表来管理不同大小的内存块。根据块大小，系统会选择适当的链表来存储空闲块，并在需要时进行分裂和合并。

#### 数据结构

1. **free_area_t**：代表每一级的空闲内存块链表，包含两个字段：
   - `free_list`：表示空闲块的链表，用于存放该级别的所有空闲内存块。
   - `nr_free`：记录当前级别的空闲块数量。

2. **BuddyMaxLevel**：定义了最大管理层级，本实现使用了 11 级，能够支持大小为 4KB 到 2MB 的内存块。

3. **`struct Page`**：表示物理页信息，其中的 `property` 字段用于表示页的大小级别。页链接字段用于将页添加到空闲链表。

#### 初始化函数

##### `buddy_system_init`
`buddy_system_init` 初始化 Buddy System，设置所有层级的空闲链表和块数量：
- 遍历 `BuddyMaxLevel` 中的每一级别，将每个空闲链表初始化为空。
- 每一级的 `nr_free` 计数器设置为 0。

##### `buddy_system_init_memmap`
`buddy_system_init_memmap` 用于初始化物理内存块，将内存分配到各个级别的空闲链表中：
- 遍历所有物理内存页，重置页标志位和引用计数，确保页面不被占用。
- 逐级分配空闲内存块，将最大块加入到最高级别。
- 每个内存块根据大小和起始地址插入对应级别的空闲链表。

#### 内存分配与释放

##### `buddy_system_alloc_pages`
`buddy_system_alloc_pages` 用于分配所需大小的页面块，步骤如下：
1. 检查请求的块大小是否超出最大块限制。
2. 找到满足需求的最小级别并检查该级别是否存在空闲块。
3. 如果当前级别为空，则调用 `split_page` 将更大块分裂。
4. 分配块，将其从空闲链表中移除，并清除空闲属性标志。

##### `split_page`
当低级别的链表无空闲块时，`split_page` 会递归调用自身，对更高一级的块进行分裂。
- 从高一级链表中取出一个空闲块，划分为两个小块。
- 将两个小块加入到当前级别的空闲链表，并更新块数量。

##### `buddy_system_free_pages`
`buddy_system_free_pages` 释放内存并尝试合并邻近的伙伴块。
- 首先检查当前块是否为 2 的幂，如果是，则将块插入到对应链表中。
- 检查该级别的伙伴块是否也为空，如果是，删除当前块和伙伴块，将它们合并为更大的块并递增到更高级别，直到无法合并为止。

#### 辅助函数

1. **`buddy_get_buddy`**：用于查找伙伴块，通过异或运算计算伙伴块的地址。
2. **`add_page`**：将块按地址顺序插入链表，确保链表中的块按地址排列，有助于后续合并操作。

#### 计算函数

##### `buddy_system_nr_free_pages`
返回系统中当前空闲页面的总数。通过遍历所有级别的空闲链表，计算每一级别中的空闲块数量并求和。

#### 测试函数

##### `basic_check` 和 `buddy_system_check`
用于测试和验证 Buddy System 的分配、释放、分裂与合并的正确性，确保系统的内存管理逻辑工作正常。

### Buddy System 的原理与优化
Buddy System 将物理内存按大小划分为不同的等级，每个等级中的块大小是固定的 2 的幂数倍。通过分裂和合并块，在内存需求多变的环境中实现动态管理，降低碎片化问题。

### 优点和缺点

**优点**：
- 内存管理效率高，支持快速分配和回收。
- 减少了内存碎片，通过合并和分裂动态调整块大小。

**缺点**：
- 需要额外的控制结构，如多个链表。
- 如果分配的大小和请求的大小不匹配，可能会浪费内存。

### 结论
此 Buddy System 实现了有效的物理内存管理，通过分裂和合并机制，优化了内存的使用效率，适用于动态内存需求的操作系统环境。
